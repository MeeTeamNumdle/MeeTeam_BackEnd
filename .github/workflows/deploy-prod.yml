# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
# This workflow will build a Java project with Gradle and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle

name: BackEnd - CI/CD(deploy)

on:
  pull_request:
    branches: [ "main" ]
    types: [ closed ]


permissions:
  contents: read

jobs:
  deploy-prod:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    environment: production
    env:
      DEPLOYMENT_GROUP_NAME: meeteam-app
      S3_BUCKET_DIR_NAME: prod
    steps:
      - name: âœ… Checkout branch
        uses: actions/checkout@v3
      # JDKë¥¼ 17 ë²„ì „ìœ¼ë¡œ ì…‹íŒ…í•œë‹¤.
      - name: âš™ï¸ Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # Gradleì„ ìºì‹±í•œë‹¤ -> ë¹Œë“œ ì†ë„ê°€ ì¦ê°€í•˜ëŠ” íš¨ê³¼ê°€ ìˆë‹¤.
      - name: âœ… Gradle ìºì‹±
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # í”„ë¡œì íŠ¸ ì €ì¥ì†Œì— ì—…ë¡œë“œí•˜ë©´ ì•ˆë˜ëŠ” ì„¤ì • íŒŒì¼ë“¤ì„ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
      - name: ğŸ—‚ï¸ Make config
        run: |
          # src/main/resources ê²½ë¡œ ì´ë™
           cd ./src/main/resources
          
          # yml íŒŒì¼ ìƒì„±
          touch ./application-prod.yml
          echo "$APPLICATION_PROD" > ./application-prod.yml
          
          # í‚¤ íŒŒì¼ ìƒì„±
          touch ./private-key.pem
          echo "$CLOUD_FRONT_KEY" > ./private-key.pem
          
          # í´ë” ìƒì„±
          mkdir templates
          
          # ë©”ì¼ ê´€ë ¨ëœ html íŒŒì¼ ìƒì„±
          cd ./templates
          touch ./ApproveMail.html
          echo "$MAIL_APPROVE_TEMPLATE" > ./ApproveMail.html
          
          touch ./UniversityAuthMail.html
          echo "$MAIL_VERIFY_TEMPLATE" > ./UniversityAuthMail.html
          
          touch ./ApplicationNotificationMail.html
          echo "$MAIL_APPLICATION_NOTIFICATION_TEMPLATE" > ./ApplicationNotificationMail.html

        env:
          APPLICATION_PROD: ${{ secrets.APPLICATION_PROD }}
          MAIL_APPROVE_TEMPLATE: ${{ secrets.MAIL_APPROVE_TEMPLATE }}
          MAIL_VERIFY_TEMPLATE: ${{ secrets.MAIL_VERIFY_TEMPLATE }}
          MAIL_APPLICATION_NOTIFICATION_TEMPLATE: ${{ secrets.MAIL_APPLICATION_NOTIFICATION_TEMPLATE }}
          CLOUD_FRONT_KEY: ${{ secrets.CLOUD_FRONT_KEY }}
        shell: bash

      - name: âš™ï¸ Gradle ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: âš™ï¸ Gradleë¡œ ë¹Œë“œ ì‹¤í–‰
        run: ./gradlew bootjar
      # ë°°í¬ì— í•„ìš”í•œ ì—¬ëŸ¬ ì„¤ì • íŒŒì¼ê³¼ í”„ë¡œì íŠ¸ ë¹Œë“œíŒŒì¼ì„ zip íŒŒì¼ë¡œ ëª¨ì•„ì¤€ë‹¤.
      - name: ğŸ“¦ zip file ìƒì„±
        run: |
          mkdir deploy
          mkdir deploy/prod
          cp ./docker/prod/docker-compose.prod.yml ./deploy/prod
          cp ./docker/prod/Dockerfile ./deploy/prod
          cp ./src/main/resources/private-key.pem ./deploy/prod
          cp ./build/libs/*.jar ./deploy/prod
          cp ./scripts/deploy.sh ./deploy/
          cp ./build/libs/*.jar ./deploy/
          zip -r -qq -j ./spring-app.zip ./deploy
      
      
      # AWSì— ì—°ê²°í•´ì¤€ë‹¤.
      - name: ğŸŒ AWS ì—°ê²°
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # S3ì— í”„ë¡œì íŠ¸ë¥¼ ì—…ë¡œë“œ í•œë‹¤.
      - name: ğŸš› S3ì— í”„ë¡œì íŠ¸ ì—…ë¡œë“œ
        run: |
          aws s3 cp \
          --region ap-northeast-2 \
          ./spring-app.zip s3://${{ secrets.S3_BUCKET_NAME }}/${{ env.S3_BUCKET_DIR_NAME }}/spring-app.zip

      # CodeDelployì— ë°°í¬ë¥¼ ìš”ì²­í•œë‹¤.
      - name: ğŸš€ Code Deploy ë°°í¬ ìš”ì²­
        run: aws deploy create-deployment --application-name meeteam-app
          --deployment-config-name CodeDeployDefault.OneAtATime
          --deployment-group-name ${{ env.DEPLOYMENT_GROUP_NAME }}
          --s3-location bucket=${{ secrets.S3_BUCKET_NAME }},bundleType=zip,key=${{ env.S3_BUCKET_DIR_NAME }}/spring-app.zip

      - name: Discord ì•Œë¦¼ ë´‡
        uses: sarisia/actions-status-discord@v1
        if: ${{ failure() }}
        with:
          title: â—ï¸ Backend CD failed â—ï¸
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          color: FF0000